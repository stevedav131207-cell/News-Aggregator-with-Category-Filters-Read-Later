{% extends 'base.html' %}

{% block title %}Dashboard - SAMACHAR{% endblock %}

{% block content %}
<div class="container-fluid">
    {% if error_message %}
    <div class="alert alert-danger" role="alert">
        {{ error_message }}
    </div>
    {% endif %}
    
    <div id="offline-banner" class="offline-banner" style="display: none;">
        <strong>You are offline.</strong> Live news cannot be fetched; showing your saved bookmarks instead.
    </div>
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            {% if category == 'india' %}
                Top Stories from India
            {% elif category == 'world' %}
                World News
            {% elif category == 'business' %}
                Business News
            {% elif category == 'technology' %}
                Technology News
            {% elif category == 'sports' %}
                Sports News
            {% elif category == 'entertainment' %}
                Entertainment News
            {% elif category == 'science' %}
                Science News
            {% else %}
                Latest News
            {% endif %}
        </h2>
        <div class="d-flex gap-2 align-items-center">
            {% if sources_used %}
            <span class="badge bg-success">
                <i class="bi bi-rss-fill"></i> {{ sources_used }} API Source{{ sources_used|pluralize }}
            </span>
            {% endif %}
            <button class="btn btn-sm btn-outline-primary" onclick="location.reload()" title="Refresh for latest news">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>
    
    {% if articles %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <p class="text-muted mb-0">Showing {{ articles|length }} article{{ articles|length|pluralize }} from multiple sources</p>
        <p class="text-muted mb-0"><small><i class="bi bi-clock"></i> Updated: <span id="last-updated"></span></small></p>
    </div>
    <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4">
        {% for article in articles %}
        <div class="col">
            <div class="card h-100">
                {% if article.urlToImage %}
                <img src="{{ article.urlToImage }}" class="card-img-top" alt="{{ article.title }}" 
                     onerror="this.src='/static/images/placeholder.svg'">
                {% else %}
                <img src="/static/images/placeholder.svg" class="card-img-top" alt="No image available">
                {% endif %}
                
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">{{ article.title }}</h5>
                    <p class="card-text">{{ article.description|truncatewords:20 }}</p>
                    
                    <div class="mt-auto">
                        <p class="card-text">
                            <small class="text-muted">
                                <strong>{{ article.source.name }}</strong><br>
                                {{ article.publishedAt|date:"M d, Y H:i" }}
                            </small>
                        </p>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <a href="{{ article.url }}" target="_blank" class="btn btn-sm btn-primary">Read more</a>
                            <button class="btn btn-sm btn-bookmark" 
                                    onclick="bookmarkArticle(this, '{{ article.title|escapejs }}', '{{ article.description|default_if_none:''|escapejs }}', '{{ article.url }}', '{{ article.urlToImage|default_if_none:'' }}', '{{ article.source.name|default_if_none:'Unknown'|escapejs }}', '{{ category|default_if_none:'general' }}', '{{ article.publishedAt|default_if_none:'' }}')">
                                <i class="bi bi-bookmark"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info" role="alert">
        No articles found. Try a different category or check back later.
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Display current time as "last updated"
    document.addEventListener('DOMContentLoaded', function() {
        const lastUpdated = document.getElementById('last-updated');
        if (lastUpdated) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            lastUpdated.textContent = timeString;
        }
    });
</script>
{% endblock %}
